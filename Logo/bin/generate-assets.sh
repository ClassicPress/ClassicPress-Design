#!/usr/bin/env bash
set -e

cd "$(dirname "$0")"
cd ..

destdir="autogenerated"
pngwidths="600 1200"

# Check for required programs
all_found=Y
for prog in grep inkscape xmllint; do
	if ! [ -x "$(command -v $prog)" ]; then
		echo "Error: required program '$prog' is not installed." >&2
		all_found=N
	fi
done
if [ $all_found = N ]; then
	exit 1
fi

# Format and indent SVG files for easier review of changes
for file in *.svg ; do
	xmllint --format $file -o $file
done

# Check for opened vectors
grep -q ' d="[^"]*[^zZ]"' *.svg &&  (
	echo "Error: some file have open paths!";
	exit 1
)

# Check for wrong titles in SVG
for file in *.svg ; do
	asset="${file%.*}"
	svgtitle=$(grep -o -E '<title>([^<]*)</title>' $file)
	if [ "$svgtitle" != "<title>${asset}</title>" ]; then
		echo "Error: mismatch in asset name and SVG title";
		exit 1
	fi
done

# Loop through SVG files
for file in *.svg ; do
	asset="${file%.*}"
	# Build PNG in their resolutions
	for width in $pngwidths; do
		tempfile="${destdir}/${asset}-${width}.png"
		inkout=$(inkscape "${file}" --export-width=$width --export-png=$tempfile)
		height=$(echo $inkout | grep -o -E "exported to [0-9]+ x [0-9]+ pixels" | cut -d " " -f 5)
		destfile="${destdir}/${asset}-${width}x${height}.png"
		mv $tempfile $destfile
	done
	# Build PDF
	destfile="${destdir}/${asset}.pdf"
	inkscape "${file}" -A $destfile

done
