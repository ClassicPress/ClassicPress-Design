#!/bin/sh

wd=`pwd`
destdir="autogenerated"
pngwidths="300 600 1200"
totalassets=6

find . -type f | grep svg >/dev/null || {
	echo "No suitable files found. Sure we are in the right dir?"
	return
}

# Dirty check for opened vectors
grep -l -E ' d="[^"]*[^zZ]"' *.svg >"$destdir/.temp" &&  (
	echo "This/those files seems to have open paths!";
	cat  "$destdir/.temp"
	echo
)
	
# Loop through SVG files 
count=0;
titleerrors="";

for file in *.svg ; do
	let "count++"
	asset="${file%.*}"
	
	# Check for valid SVG title
	svgtitle=$(awk 'BEGIN{IGNORECASE=1;FS="<title>|</title>";RS=EOF} {print $2}' $file)
	if [ "$svgtitle" != "$asset" ]; then
		titleerrors="${titleerrors}Title mismatch in ${file}, should be ${asset}, not ${svgtitle}\n"
	fi
	
	# Build PNG in their resolutions
	for width in $pngwidths; do
		tempfile="${wd}/${destdir}/${asset}-${width}.png"
		inkout=$(inkscape "${wd}/${file}" --export-width=$width --export-png=$tempfile)
		height=$(echo $inkout | grep -o -E "exported to [0-9]+ x [0-9]+ pixels" | cut -d " " -f 5)
		destfile="${wd}/${destdir}/${asset}-${width}x${height}.png"
		mv $tempfile $destfile
	done
	
	# Build PDF
	destfile="${wd}/${destdir}/${asset}.pdf"
	inkscape "${wd}/${file}" -A $destfile

done

if [ $count != $totalassets ]
	then
		echo "$count files processed. $totalassets expected. Please check."
fi
echo -ne $titleerrors
rm "$destdir/.temp"