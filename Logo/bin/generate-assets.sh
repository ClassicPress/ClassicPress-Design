#!/usr/bin/env bash
set -e

wd=`pwd`
destdir="autogenerated"
pngwidths="600 1200"

# Check for required programs
if ! [ -x "$(command -v grep)" ]; then
  echo 'Error: grep is not installed.' >&2
  exit 1
fi

if ! [ -x "$(command -v inkscape)" ]; then
  echo 'Error: inkscape is not installed.' >&2
  exit 1
fi

if ! [ -x "$(command -v xmllint)" ]; then
  echo 'Error: xmllint is not installed.' >&2
  exit 1
fi

# check for no files
find . -type f | grep svg >/dev/null || {
	echo "Error: no suitable files found. Sure we are in the right dir?"
	exit 1
}

#
for file in *.svg ; do
	xmllint --format $file -o $file
done

# Check for opened vectors
grep -q ' d="[^"]*[^zZ]"' *.svg &&  (
	echo "Error: some file have open paths!";
	exit 1
)

# Check for wrong titles in SVG
for file in *.svg ; do
	asset="${file%.*}"
	svgtitle=$(grep -o -E '<title>([^<]*)</title>' $file)
	if [ "$svgtitle" != "<title>${asset}</title>" ]; then
		echo "Error: mismatch in asset name and SVG title";
		exit 1
	fi
done

# Loop through SVG files 
for file in *.svg ; do
	asset="${file%.*}"
	# Build PNG in their resolutions
	for width in $pngwidths; do
		tempfile="${wd}/${destdir}/${asset}-${width}.png"
		inkout=$(inkscape "${wd}/${file}" --export-width=$width --export-png=$tempfile)
		height=$(echo $inkout | grep -o -E "exported to [0-9]+ x [0-9]+ pixels" | cut -d " " -f 5)
		destfile="${wd}/${destdir}/${asset}-${width}x${height}.png"
		mv $tempfile $destfile
	done
	# Build PDF
	destfile="${wd}/${destdir}/${asset}.pdf"
	inkscape "${wd}/${file}" -A $destfile

done
