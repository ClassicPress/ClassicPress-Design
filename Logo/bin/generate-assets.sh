#!/usr/bin/env bash
set -e

cd "$(dirname "$0")"
cd ..

destdir="autogenerated"
pngwidths="600 1200"

# Check for required programs
all_found=Y
for prog in grep inkscape xmllint; do
	if ! [ -x "$(command -v $prog)" ]; then
		echo "Error: required program '$prog' is not installed." >&2
		all_found=N
	fi
done
if [ $all_found = N ]; then
	exit 1
fi

# Format and indent SVG files for easier review of changes
for file in *.svg ; do
	XMLLINT_INDENT="$(echo -e '\t')" xmllint --format "$file" -o "$file"
done

# Check for opened vectors
for file in *.svg ; do
	if grep -q ' d="[^"]*[^zZ]"' "$file"; then
		echo "Error: file has open paths: $file";
		exit 1
	fi
done

# Check for wrong titles in SVG
for file in *.svg ; do
	asset="${file%.*}"
	svgtitle=$(grep -o -E '<title>([^<]*)</title>' "$file")
	if [ "$svgtitle" != "<title>${asset}</title>" ]; then
		echo "Error: mismatch in asset name and SVG title";
		exit 1
	fi
done

# Loop through SVG files
for file in *.svg ; do
	asset="${file%.*}"
	# Build PNG in their resolutions
	for width in $pngwidths; do
		tempfile="${destdir}/tmp-${asset}-${width}.png"
		inkout=$(inkscape "${file}" --export-width=$width --export-png="$tempfile" 2>&1)
		height=$(echo "$inkout" | grep -o -E "exported to [0-9]+ x [0-9]+ pixels" | cut -d " " -f 5)
		if [ -z "$height" ]; then
			echo 'Image height not detected in inkscape output:'
			echo "$inkout"
			exit 1
		fi
		destfile="${destdir}/${asset}-${width}x${height}.png"
		echo "$destfile"
		mv "$tempfile" "$destfile"
	done
	# Build PDF
	destfile="${destdir}/${asset}.pdf"
	inkscape "${file}" -A "$destfile" 2>/dev/null
	echo "$destfile"
done
