#!/bin/sh

wd=`pwd`
destdir="autogenerated"
pngwidths="300 600 1200"
totalassets=6

find . -type f | grep svg >/dev/null || {
	echo "No suitable files found. Sure we are in the right dir?"
	return
}

# Dirty check for opened vectors
grep -l -E ' d="[^"]*[^zZ]"' *.svg >"$destdir/.temp" &&  (
	echo "This/those files seems to have open paths!";
	cat  "$destdir/.temp"
	echo
)
	
# Loop through SVG files 
count=0;
titleerrors="";
echo -ne "------\r"
for file in *.svg ; do
	let "count++"
	asset="${file%.*}"
	
	# Check for valid SVG title
	svgtitle=$(awk 'BEGIN{IGNORECASE=1;FS="<title>|</title>";RS=EOF} {print $2}' $file)
	if [ "$svgtitle" != "$asset" ]; then
		titleerrors="${titleerrors}Title mismatch in ${file}, should be ${asset}, not $svgtitle\n"
	fi
	
	# Get info from our SVG
	svgwidth=$(gawk '{ match($0, /viewBox=" *([0-9\.]+) +([0-9\.]+) +([0-9\.]+) +([0-9\.]+) *"/,res) ;print res[3]}' $file)
	svgheight=$(gawk '{ match($0, /viewBox=" *([0-9\.]+) +([0-9\.]+) +([0-9\.]+) +([0-9\.]+) *"/,res) ;print res[4]}' $file)
	
	# Build PNG in their resolutions
	for width in $pngwidths; do
		height=$(echo "scale=10; $svgheight * $width / $svgwidth +0.5 " | bc -l | awk '{$1=int($1)}1' )
		destfile="${wd}/${destdir}/${asset}-${width}x${height}.png"
		cairosvg							\
			--format		png				\
			--output-width  $width			\
			--output-height $height			\
			--output 		$destfile		\
			$file
	done
	
	# Build PDF
	destfile="${wd}/${destdir}/${asset}.pdf"
	inkscape "${wd}/${file}" -A $destfile

	echo -n "X"
done
echo
if [ $count != $totalassets ]
	then
		echo "$count files processed. $totalassets expected. Please check."
fi
echo -ne $titleerrors
rm "$destdir/.temp"