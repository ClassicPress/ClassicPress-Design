#!/bin/sh

destdir="autogenerated"
pngwidths="300 600 1200"
totalassets=6

find . -type f | grep svg >/dev/null || {
	echo "No suitable files found. Sure we are in the right dir?"
	return
}

# Dirty check for opened vectors
grep -l -E ' d="[^"]*[^zZ]"' *.svg >"$destdir/.temp" &&  (
	echo "This/those files seems to have open paths!";
	cat  "$destdir/.temp"
	echo
)
	
# Loop through SVG files 
count=0;
echo -ne "------\r"
for file in *.svg ; do
	let "count++"
	asset="${file%.*}"
	
	# Get info from our SVG
	svgwidth=$(gawk '{ match($0, /viewBox=" *([0-9\.]+) +([0-9\.]+) +([0-9\.]+) +([0-9\.]+) *"/,res) ;print res[3]}' $file)
	svgheight=$(gawk '{ match($0, /viewBox=" *([0-9\.]+) +([0-9\.]+) +([0-9\.]+) +([0-9\.]+) *"/,res) ;print res[4]}' $file)
	
	# Build PNG in their resolutions
	for width in $pngwidths; do
		height=$(echo "scale=10; $svgheight * $width / $svgwidth +0.5 " | bc -l | awk '{$1=int($1)}1' )
		destfile="${destdir}/${asset}-${width}x${height}.png"
		cairosvg							\
			--format		png				\
			--output-width  $width			\
			--output-height $height			\
			--output 		$destfile		\
			$file
	done
	
	# Build PDF
	destfile="${destdir}/${asset}.pdf"
	cairosvg							\
		--format		pdf				\
		--output 		$destfile		\
		$file
	
	# Build EPS using GhostScript
	midfile="${destdir}/${asset}.ps"
	destfile="${destdir}/${asset}.eps"
	cairosvg							\
		--format		ps				\
		--output 		$midfile		\
		$file
	gs -dBATCH -dNOPAUSE -q -sDEVICE=eps2write -sOutputFile=$destfile $midfile
	rm $midfile
	
	echo -n "X"
done
echo
if [ $count != $totalassets ]
	then
		echo "$count files processed. $totalassets expected. Please check."
fi
rm "$destdir/.temp"